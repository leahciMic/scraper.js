var SharedFolderDialog=function(e){var t={additionalHeaderClasses:["icon"],closeButtonEnabled:!0,maximizeButtonEnabled:!0,buttonAlign:this.RIGHT_ALIGN};Dialog.call(this,e,t),this.existingUsers=null,this.folder=null};SharedFolderDialog.prototype=Object.create(Dialog.prototype),SharedFolderDialog.prototype.constructor=SharedFolderDialog,function(e){SharedFolderDialog.prototype.initialize=function(e){Dialog.prototype.initialize.apply(this,arguments),function(e){var t,r=document.getElementById("sharedFolderDialogUserTypeahead");LPProxy.isEnterpriseUser()?(t=new BloodhoundDropdown(r,{identify:function(e){return"group"===e.type?e.cgid:e.uid},remote:{url:LPProxy.getBaseURL()+"typeahead_remote.php?grp=1&q=%QUERY",wildcard:"%QUERY"}},{optionLabel:function(e){var t=e.name;return"companyuser"===e.type?""===t?t=e.email:""!==e.email&&(t+=" ("+e.email+")"):t+=" ("+Strings.Vault.USER_GROUP+")",t},ignore:function(t,r){return e.existingUsers[t]||void 0===r.type&&!LPFeatures.allowShareOutsideEnterprise()}}),t.onChange(function(t,r){t=$.extend({},t);var i=SharedFolderUser;"group"===t.type&&(t.uid=t.cgid,delete t.cgid,i=SharedFolderUserGroup),t.username=t.email,delete t.email;var s=new i(t,e.folder);s._pending=!0,e.addNewUser(s),e.existingUsers[r]=!0}),e.inputFields.friends=t):e.inputFields.friends=t=new TypeaheadDropdown(r),t.autocomplete=function(t){var r=t.target.value;if(null===this.hint&&r){for(var i=e.parseFriendsInput(r),s=0,n=i.length;s<n;++s)e.addNewUser(i[s]);t.preventDefault()}TypeaheadDropdown.prototype.autocomplete.apply(this,arguments)},Topics.get(Topics.REMOVED_SHARED_FOLDER_USER).subscribe(function(t){delete e.existingUsers[t.getID()],e.showHideInviteInput()}),$("#sharedFolderDialogInviteButton").bind("click",function(){e.submit()})}(this)},SharedFolderDialog.prototype.parseFriendsInput=function(e){for(var t=[],r=e.split(","),i=0,s=r.length;i<s;++i){var n,a=r[i].trim();if(a.indexOf("@")>-1){var o=a.match(Constants.EmailAddressRegularExpression);if(o&&1===o.length){var d=o[0];n=new SharedFolderUser({username:d},this.folder)}}else a&&(n=new SharedFolderUserGroup({name:a},this.folder));n&&(n._pending=!0,n.setEditable(!0),t.push(n))}return t},SharedFolderDialog.prototype.validate=function(e){var t=Dialog.prototype.validate.apply(this,arguments);return e.friends&&0===this.parseFriendsInput(e.friends).length&&(this.addError("friends","You must enter a valid email or group name."),t=!1),t},SharedFolderDialog.prototype.defaultFields=function(e){e.defaultData=$.extend({readonly:!0,hidePasswords:!0},e.defaultData),Dialog.prototype.defaultFields.call(this,e)},SharedFolderDialog.prototype.addNewUser=function(e){this.containers.newMembers||(this.containers.newMembers=new Container([],{additionalItemClasses:"dialogItem"}),this.containers.newMembers.initialize(document.getElementById("sharedFolderDialogNewUsersContainer"))),this.containers.newMembers.addChild(e),this.inputFields.friends.clear(),this.inputFields.friends.focus()},SharedFolderDialog.prototype.setup=function(t,r){Dialog.prototype.setup.apply(this,arguments),this.containers.existingMembers&&(this.containers.existingMembers.initialize(e.getElementById("folderMembers")),this.showHideInviteInput())},SharedFolderDialog.prototype.showHideInviteInput=function(){LPProxy.isEnterpriseUser()||(this.containers.existingMembers.getItemChildren().length>5?($("#sharedFolderMaxMembers").show(),$("#sharedFolderDialogInvites").hide()):($("#sharedFolderMaxMembers").hide(),$("#sharedFolderDialogInvites").show()))},SharedFolderDialog.prototype.open=function(e){this.folder=e,function(t){LPRequest.makeDataRequest(LPProxy.getSharedFolderMembers,{params:{shareid:e.getID()},success:function(r){for(var i=[],s=0,n=r.users.length;s<n;++s)i.push(new SharedFolderUser(r.users[s],e));for(var s=0,n=r.groups.length;s<n;++s)i.push(new SharedFolderUserGroup(r.groups[s],e));t.containers.existingMembers=new Container(i),t.existingUsers={};for(var s=0,n=i.length;s<n;++s)t.existingUsers[i[s].getID()]=!0;Dialog.prototype.open.call(t,{title:Strings.translateString("Manage Shared Folder")+": "+t.folder.getShareGroupName()})},error:function(){Topics.get(Topics.DIALOG_LOADED).publish()}})}(this)},SharedFolderDialog.prototype.getInvitedMembers=function(){var e=this.containers.newMembers?this.containers.newMembers.getItems():[];return e=e.concat(this.parseFriendsInput(this.inputFields.friends.getValue()))},SharedFolderDialog.prototype.getData=function(){var e=Dialog.prototype.getData.apply(this,arguments);e.newMembers={},e.updatedPermissions=[];var t=this.getInvitedMembers();if(t.length>0)for(var r=0,i=t.length;r<i;++r){var s=t[r];e.newMembers[s.getUsername()]={uid:s.getID(),type:s.getType()}}else for(var n=this.containers.existingMembers.getItemChildren(),r=0,i=n.length;r<i;++r){var a=n[r];a.isModified()&&e.updatedPermissions.push({uid:a.getID(!0),give:a.getCheckboxValue("give"),readonly:a.getCheckboxValue("readonly"),canadminister:LPProxy.isEnterpriseUser()?a.getCheckboxValue("can_administer"):"0"})}return e},SharedFolderDialog.prototype.handleSubmit=function(e){var t=$.extend(e,{sharedFolder:this.folder._data,shareInfo:this.folder._shareInfo});LPTools.hasProperties(e.newMembers)?LPRequest.makeRequest(LPProxy.addSharedFolderMembers,{params:t,requestSuccessOptions:{closeDialog:!1},success:this.createDynamicHandler(function(t){for(var r=[],i=this.getInvitedMembers(),s=0,n=i.length;s<n;++s){var a=i[s];t[a.getUsername()]&&(a._pending=!1,a._data.readonly=e.readonly?"1":"0",a._data.give=e.hidePasswords?"0":"1",a._data.can_administer=e.can_administer?"1":"0",a.rebuild(),r.push(a)),a._parent&&a._parent.removeChild(a)}this.containers.existingMembers.addChild(r),this.showHideInviteInput(),this.inputFields.friends.clear()})}):e.updatedPermissions.length>0?LPRequest.makeRequest(LPProxy.updateSharedFolderMemberPermissions,{params:t,success:this.createHandler(function(){for(var t=this.containers.existingMembers.getItemChildren(),r={},i=0,s=t.length;i<s;++i){var n=t[i];r[n.getID(!0)]=n}for(var i=0,s=e.updatedPermissions.length;i<s;++i){var a=e.updatedPermissions[i];r[a.uid].updatePermissions(a)}})}):this.close(!0)}}(document);