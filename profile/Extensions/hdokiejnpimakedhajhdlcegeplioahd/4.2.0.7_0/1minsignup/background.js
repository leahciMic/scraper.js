!function(){function e(e){e.data&&e.data.forEach(function(n){var r=n.appId,a=l.getTabPropertiesByAppId(r);if(a.currentState!==d.done&&oneMinuteSignup.MessageService.sendLog(a.appId,a.type,"Script running not in done state"),a.setState(d.running),a.setTimeout(u),a.appLoginUrl=n.appLoginUrl||n.url,a.appName=n.appName,a.url=n.url,a.username=n.username,a.activeScript=n.script,e.type===c.ResetRequestScript)a.type=g.request,a.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(g.request,n.username);else if(e.type===c.ResetScript){a.type=g.change;var i=oneMinuteSignup.AppService.generatePassword(n.passwordPolicy);console.log(n.url,i),a.newPassword=i,a.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(g.change,i)}else e.type===c.LogoutScript&&(a.type=g.logout,a.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(g.logout));if(console.log("App: "+a.appId+" Clear cookies"),n.url)l.createTabOrNavigate(a,function(e){});else{t({error:new Error("No "+n.scriptType+"url found on "+n.appName)},a)}})}function n(e){var n=l.getTabPropertiesByAppId(e.appId);oneMinuteSignup.ExtensionProxyService.focusTabById(n.tabId)}function r(e){e&&(e.currentState===d.done?oneMinuteSignup.MessageService.sendLog(e.appId,e.type,"Script done but got UseInfoNeeded"):(e.clearTimeout(),e.setState(d.suspended),oneMinuteSignup.MessageService.sendUserInfoNeeded(e.appId,e.type)))}function a(e){e&&(e.clearTimeout(),e.currentState===d.done?oneMinuteSignup.MessageService.sendLog(e.appId,e.type,"Script running already in done state"):(e.currentState===d.suspended&&oneMinuteSignup.ExtensionProxyService.focusTabById(S),e.setState(d.done),l.closeTab(e),oneMinuteSignup.MessageService.sendDone(e.appId,e.type),e.type===g.change&&s(e.appName,e.appId,e.appLoginUrl,e.username,e.newPassword)))}function t(e,n){n&&(n.currentState===d.done?oneMinuteSignup.MessageService.sendLog(n.appId,n.type,"Script done but got Error"):(n.setState(d.done),l.closeTab(n),e&&e.error&&(e.error.message=JSON.stringify({exception:e.error.message,loginUrl:n.appLoginUrl,appName:n.appName,appId:n.appId,scriptType:n.type,url:n.url})),oneMinuteSignup.MessageService.sendError(e||{},n.appId,n.url,n.type)))}function i(e){var n=l.getTabPropertiesByAppId(e.appId);l.closeTab(n)}function p(e,n){v=n,l.createTab({url:e.url},function(e){y=e,l.focusTabById(e)})}function o(e){oneMinuteSignup.ExtensionProxyService.focusTabById(v),oneMinuteSignup.MessageService.sendOauthToken(e.token,e.state),l.closeTab({tabId:y})}function s(e,n,r,a,t){var i=get_default_group(r),p={url:r,formdata2:"",group:i&&!g_nofolder_feature_enabled?i:"(none)",name:e,username:a,password:t,notes:"",orig_username:a,orig_password:t};if(!lploggedin)return null;var r=punycode.URLToASCII(p.url),o=p.formdata2,s=p.name,u=p.group,c=p.username,t=p.password,d=p.orig_username,g=p.orig_password,l=null!=o&&o.length>0,S=issharedfolder(g_shares,u);if(!checkreadonly(S))return{error:gs("Sorry, this shared folder is read-only.")};var y=0==S?g_local_key:S.sharekey,v=createNewAcct(),f=lp_gettld_url(AES._utf8_encode(r));v.genpw=!1,v.name=s,v.group=u,v.url=AES._utf8_encode(r),v.tld=f,v.unencryptedUsername=c,v.username=lpmenc(c,!0,y),v.password=lpmenc(t,!0,y),v.extra="",v.fav=0,v.autologin=0,v.never_autofill=0,v.pwprotect=0,v.aid="0",0!=S&&(v.sharefolderid=S.id,0==S.give&&(v.sharedfromaid=1));var b=u;S&&(b=u.substr(S.decsharename.length+1)),v.fields=new Array,v.save_all=p.save_all?1:0;var m=[],M={save_all:0,username:d,password:g,new_username:c,new_password:t,fromiframe:1},T=updateAndEncryptData(o,v.fields,m,v,y,M),I="name="+en(lpenc(s,y))+"&grouping="+en(lpenc(b,y))+"&data="+en(bin2hex(T))+"&extra="+en(lpenc("",y));if(I+="&extjs=1&localupdate=1",I+=0==S?"":"&sharedfolderid="+en(S.id),v.newvalues=m,l)I+="&ref="+en(AES.url2hex(r));else{I+="&aid=0",I+="&url="+en(AES.url2hex(r)),I+="&openid_url=",I+="&username="+en(crypto_btoa(v.username)),I+="&password="+en(crypto_btoa(v.password)),I+="&auto=1"+get_identity_param();var _=is_application(v),h=(_?v.appaid:v.aid,{url:base_url+(_?"addapp.php":"show.php"),postdata:I,successCallback:function(e,r){var a=e.responseXML.documentElement.getElementsByTagName("result")[0];if(a){if("added"===a.getAttribute("action")){var i=a.getAttribute("aid");oneMinuteSignup.MessageService.sendSavedToVault(n,u,t,i)}}},acct:v});lpMakeRequest(h.url,I,h.successCallback,h.successCallback,p)}}function u(e){e.setState(d.done),l.closeTab(e);var n=new Error("Script timeout"),r={error:{name:n.name,stack:n.stack,message:JSON.stringify({exception:"Script timeout",loginUrl:e.appLoginUrl,appName:e.appName,appId:e.appId,scriptType:e.type,url:e.url})},type:oneMinuteSignupMessageType.Error,appId:"",scriptType:""};oneMinuteSignup.MessageService.sendError(r,e.appId,e.url,e.type)}var c=(new RegExp(base_url||lp_base,"gi"),oneMinuteSignupMessageType),d=oneMinuteSignup.ScriptState,g=oneMinuteSignup.ScriptType,l=new oneMinuteSignup.TabService,S=null,y=null,v=null;oneMinuteSignup.ExtensionProxyService.onMessage(function(s,u,d){var g=l.getTabPropertiesByTabId(u);switch(s.type){case c.ResetRequestScript:case c.ResetScript:case c.LogoutScript:S=u,oneMinuteSignup.MessageService.tabId=u,e(s),d();break;case c.Done:console.log("DONE APP",g,u),a(g),d();break;case c.Error:t(s,g),d();break;case c.NavigateToTab:n(s),d();break;case c.UserInformationNeeded:r(g),d();break;case c.GetToken:S=u,oneMinuteSignup.MessageService.tabId=u,oneMinuteSignup.MessageService.sendToken(),d();break;case c.LaunchApplication:oneMinuteSignup.ExtensionProxyService.createTab(s.data.url,!0,function(){}),d();break;case c.CloseTab:i(s),d();break;case c.GetOauthToken:S=u,oneMinuteSignup.MessageService.tabId=u,p(s,u),d();break;case c.ReceivedOauthToken:o(s),d()}}),oneMinuteSignup.ExtensionProxyService.onUpdateTab(function(e,n){var r=l.getTabPropertiesByTabId(e);r&&(console.log("App: "+r.appId+" Change url",n),r.currentState!==oneMinuteSignup.ScriptState.done&&(console.log("App: "+r.appId+" Execute script"),oneMinuteSignup.ExtensionProxyService.executeScriptWithFrameWork(r)))})}();