function lpnp_init(){if(!g_np_init){if(!g_is_win&&!g_is_mac&&!g_is_linux)return void(g_np_init=!1);if(g_issafari&&g_is_win)return void(g_np_init=!1);if(!have_binary())return void lpdbg("namedpipes","named pipe server could not be started");if(is_chrome_portable())return void(g_np_init=!1);lpdbg("namedpipes","lpnp_init : initializing named pipe server");namedpipeobserverfunction={observe:function(e,a,n){"lpxpcom"==a&&process_ipc_msg(n,"pipes")}}.observe,call_binary_function("StartNamedPipeServer"),g_np_init=!0,setTimeout(function(){lpnp_notify("logincheck")},1e3),(g_issafari&&g_is_mac||g_isfirefoxsdk)&&lpnp_get_javascript_message()}}function lpnp_get_javascript_message(){have_binary_function("get_javascript_message")&&call_binary_function("get_javascript_message",function(e){e.length>0&&namedpipeobserverfunction(null,"lpxpcom",e),setTimeout(function(){lpnp_get_javascript_message()},0==e.length?2e3:0)})}function lpnp_notify(e,a){if(!LPISLOC||"refresh_local"==e||"local_pwchange"==e){if(1==lpGetPref("enablenamedpipes",1)){var n=lpnp_xml_msg(e,a);if(lp_ws&&lp_ws.isconnected()&&!have_nplastpass()&&!have_native_messaging())return void lp_ws.send(n);g_np_init&&have_binary_function("SendNamedPipeMessageToAll")&&(lpdbg("namedpipes","broadcasting "+n),call_binary_function("SendNamedPipeMessageToAll",n))}}}function lpnp_xml_msg(e,a){var n,i="<"+e;if(void 0!==a)for(n in a)i+=" "+n+'="'+lpxmlescape(a[n])+'"';return i+="/>"}function lpnp_send_internal_logincheck_ack(){lploggedin&&getuuid(function(e){var a=new Array;a.data0=lp_phpsessid,a.data1=g_username,a.data2=g_identity,have_binary()||(a.data3=e,a.data4=lpCreateKeyFileData(),a.data5=get_key_iterations(g_username)),lpnp_notify("internal_logincheck_ack",a)},g_username_hash)}function process_ipc_msg(e,a){try{var n="",i=e.match(/^<([^ \/]+)/);if(i){if(n=i[1],"websocket"==a&&"launch"!=n&&(have_nplastpass()||have_native_messaging()||1!=lpGetPref("enablenamedpipes",1)))return}else if("{"==e[0]){try{native_messaging_message(LPJSON.parse(e),null,!0)}catch(e){}return}if(LPISLOC&&"refresh_local"!=n&&"local_pwchange"!=n)return;switch(lpdbg("namedpipes","received cmd="+n+" data="+e),n){case"pipeinitdone":call_binary_function("NamedPipeNumClients",function(e){if(e>1){var a=new Array;setTimeout(function(){lpnp_notify("internal_logincheck",a)},g_is_win?0:1e3),setTimeout(function(){lp_StartLogin()},g_is_win&&!g_isfirefoxsdk?2e3:3e3)}else lp_StartLogin()});break;case"logout":console_log("LOGGING OFF : namedpipes : logoff"),lplogoff(!0,"namedpipes1");break;case"login":var t=e.match(/data0=\"([^\"]*)\"/),l=e.match(/data1=\"([^\"]*)\"/);if(t&&l){var s=lpxmlunescape(t[1]),p=lpxmlunescape(l[1]);""!=s&&""!=p&&LP_do_login(s,p)}break;case"refresh":refresh_windows();break;case"switchidentity":var l=e.match(/data0=\"([^\"]*)\"/);if(l){var _=lpxmlunescape(l[1]);switch_identity(_,!0,!1,!0)}break;case"launch":var l=e.match(/id=\"([^\"]*)\"/),r=e.match(/existing=\"([^\"]*)\"/);if(l){var c=lpxmlunescape(l[1]),o=new Array;o.data0=c,lpnp_notify("launchok",o),r?fillaid(c):(launch(c),browser_focus())}break;case"internal_logincheck":lpnp_send_internal_logincheck_ack();break;case"internal_logincheck_ack":g_np_gotack=!0;var g=e.match(/data0=\"([^\"]*)\"/),s=e.match(/data1=\"([^\"]*)\"/),d=e.match(/data2=\"([^\"]*)\"/),u=e.match(/data3=\"([^\"]*)\"/),m=e.match(/data4=\"([^\"]*)\"/),f=e.match(/data5=\"([^\"]*)\"/);if(!lploggedin&&g&&s){set_default_login_username(lpxmlunescape(s[1]));var h=g_username_hash,b=g_username;g_username=lpusername=lpxmlunescape(s[1]),g_username_hash=SHA256(lpxmlunescape(s[1])),g_identity=""+(d?lpxmlunescape(d[1]):""),lpPutUserPref("identity",d?lpxmlunescape(d[1]):""),null!=b&&(g_username=lpusername=b,g_username_hash=lpusername_hash=h),lpWriteAllPrefs(),lp_phpsessid=lpxmlunescape(g[1]),rsa_setpendingsharests(),have_binary()||(u&&u.length>1&&u[1].length&&localStorage_setItem(db_prepend("lp.uid"),lpxmlunescape(u[1])),m&&m.length>1&&m[1].length&&lpSaveData(lpxmlunescape(m[1]),"key"),f&&f.length>1&&f[1].length&&localStorage_setItem(g_username_hash+"_key_iter",f[1])),have_binary_function("read_file")?call_binary_function("read_file",db_prepend(SHA256(lpxmlunescape(s[1]))+"_lpall.slps"),function(e){var a=function(e){if("string"==typeof e&&""!=e){var a=opendb();if(createDataTable(a),a){var n=db_prepend(SHA256(lpxmlunescape(s[1])));g_indexeddb?a.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:n,type:"key",data:e,usertype:n+"_key"}).onsuccess=function(e){lp_StartLogin(!0)}:a.transaction(function(a){a.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, 'key', ?)",[n,e],function(e,a){lp_StartLogin(!0)},function(e,a){console_log(a)})})}}};"string"!=typeof e||""==e?call_binary_function("read_file",db_prepend(SHA256(lpxmlunescape(s[1]))+"_lpall.lps"),function(e){"string"==typeof e&&""!=e&&protect_data(e,!0,null,function(e){call_binary_function("write_file",db_prepend(SHA256(lpxmlunescape(s[1]))+"_lpall.slps"),e),call_binary_function("delete_file",db_prepend(SHA256(lpxmlunescape(s[1]))+"_lpall.lps"))}),a(e)}):unprotect_data(e,!0,a)}):(g_loginstarted=!1,lp_StartLogin(!0,lp_phpsessid))}else lploggedin&&s&&g_username!=lpxmlunescape(s[1])&&(console_log("LOGGING OFF : namedpipes : different username"),lplogoff(!1,"namedpipes2"));break;case"refresh_local":var v=e.match(/data0=\"([^\"]*)\"/);v&&lpxmlunescape(v[1])==g_username_hash&&(console_log("named_pipes: refresh_local reparsing"),get_accts_local());break;case"local_pwchange":console_log("LOGGING OFF : namedpipes : local_pwchange"),lplogoff(!1,"namedpipes3");break;case"wscapabilities":var y=e.match(/functions=\"([^\"]*)\"/);y&&y.length>1&&(console_log("Got Capabilities Message: "+y[1]),g_ws_functions=y[1].split(","));break;default:lpdbg("namedpipes","received unknown message. data="+e)}}catch(e){}}var g_np_init=!1,namedpipeobserverfunction=null,g_np_gotack=!1;