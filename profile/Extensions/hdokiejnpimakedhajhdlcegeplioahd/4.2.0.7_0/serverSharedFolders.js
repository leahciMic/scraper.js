LPServer.sharing=LPServer.sharing||{},LPServer.sharing.folder=function(){var e=function(e,r){r.success(e,{sharedFolder:r.params.sharedFolder,shareInfo:r.params.shareInfo})},r=function(e,r,a){if(r.length>0){e.adminuidcnt=r.length;for(var s=0,n=r.length;s<n;++s){var t=r[s],u=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(u,t.key),e["adminsharekey"+s]=u.encrypt(LPServer.ext.bin2hex(a)),e["adminuid"+s]=t.uid}}},a=function(){var e=function(e){var r=[];if(e.groupname)for(var a=e.groupname.split(","),s=0,n=a.length;s<n;++s)r.push(a[s]);return r},r=function(r,a){if(r.success){for(var s={},n=0;void 0!==r["pubkey"+n];)s[r["username"+n]]={uid:r["uid"+n],cgid:r["cgid"+n],pubkey:r["pubkey"+n]},++n;var t=e(r);t.length>0&&LPServer.callback(a,"emptyGroups",t),a.success(s)}else a.error()},a={nouser:function(e,r){r.error&&r.error(""),LPServer.callback(r,"invite",{emails:e.unknownusers.split(",")})},default:r,emptygroup:r,noshareerr:function(e,r){r.error(LPServer.ext.translate("Sorry, company policy prohibits use of this feature."))}};return function(e){LPServer.jsonRequest({url:"share.php",data:{getpubkey:1,uid:"string"==typeof e.params.userInfo?e.params.userInfo:JSON.stringify(e.params.userInfo),jsonr:1},callbacks:a,userSupplied:e})}}(),s=function(e){LPServer.jsonRequest({url:"getSharedFolderMembers.php",data:{shareid:e.params.shareid},userSupplied:e})},n=function(){var e=function(e,r){var a=new LPServer.ext.RSAKey;return LPServer.ext.parsePublicKey(a,r),a.encrypt(LPServer.ext.bin2hex(e))},r=function(e,r){for(var a in r){var s=r[a];if("group"===s.type&&e.cgid===s.uid)return a}return null},s=function(a,s){var n={id:s.params.shareInfo.id,update:1,add:1,sharename:s.params.shareInfo.sharename,name:s.params.shareInfo.name,readonly:s.params.readonly?1:0,give:s.params.hidePasswords?0:1,notify:s.params.notify?1:0,canadminister:s.params.can_administer?1:0,xmlr:1},t=s.params.newMembers?s.params.newMembers:{},u=0,i=0,d=[],o={};for(var p in a){var l=a[p];t[p]&&void 0!==t[p]||(t[p]={}),l.readOnly="object"==typeof t&&t[p].readOnly?1:n.readonly,l.canAdminister="object"==typeof t&&t[p].canAdminister?1:n.canadminister,l.give="object"!=typeof t||t[p].hidePasswords?n.give:1,l.pubkey?(n["sharekey"+u]=e(s.params.shareInfo.key,l.pubkey),n["uid"+u]=l.uid,n["cgid"+u]=l.cgid,n["readonly"+u]=l.readOnly,n["canadminister"+u]=l.canAdminister,n["give"+u]=l.give,++u):(n["msfuser"+i]=l.uid,n["msfcgid"+i]=l.cgid,n["msfreadonly"+i]=l.readOnly,n["msfcanadminister"+i]=l.canAdminister,n["msfgive"+i]=l.give,d.push(p),++i),o[r(l,t)||p]=!0}var c=u+i;c>0?LPServer.xmlRequest({url:"share.php",data:n,callbacks:{useradded:function(e,r){c<=6&&d.length>0&&LPServer.callback(r,"noSharingKeyUsers",d),r.success(LPServer.ext.translate("%1 users/groups were invited.",Object.keys(o).length),o)}},userSupplied:s}):s.error()};return function(e){a(LPServer.extend({},e,{params:{userInfo:e.params.newMembers},success:function(r){s(r,e)}}))}}(),t=function(){var s={ok:function(r,a){var s=LPServer.getAttr(r,"id");a.params.sharedFolder.aid=s,a.params.shareInfo.id=s,a.params.shareInfo.shareid=s,a.params.shareInfo.uid=LPServer.getAttr(r,"uid"),e(LPServer.ext.translate("Shared Folder %1 created.",a.params.sharedFolder.group),a)},exceededlimit:function(e,r){r.error(LPServer.ext.translate("Sorry, as a LastPass Premium user, you are limited to one Shared Folder. Please consider using LastPass Enterprise if you would like more."))},premiumrequired:function(e,r){r.error(LPServer.ext.translate("Sorry, LastPass Premium is required to create a Shared Family Folder"))},alreadyexists:function(e,r){r.error(LPServer.ext.translate("That group already exists."))}},n=function(e,a){var n=e[a.params.username].pubkey;if(n){var t=a.params.sharedFolder,u=a.params.shareInfo=a.params.shareInfo||{},i={id:0,update:1,newusername:a.params.username+"-"+t.group,name:0===t.group.indexOf("Shared-")?t.group.substring("Shared-".length):t.group,xmlr:1},d=LPServer.ext.makeRandomPassword(),o=u.key=LPServer.ext.makeKey(i.newusername,d,5e3);i.newhash=LPServer.ext.makeHash(o,d,5e3);var p=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(p,n),i.sharekey=u.sharekey=p.encrypt(LPServer.ext.bin2hex(o)),i.sharename=u.sharename=LPServer.ext.encryptCBC(t.group,o),r(i,a.params.superusers,o),LPServer.xmlRequest({url:"share.php",data:i,callbacks:s,userSupplied:a})}else LPServer.callback(a,"sharingkeyrequired"),a.error&&a.error("")},t=function(e,r){var s={};s[r.params.username]={uid:r.params.uid,type:"companyuser"},r.params.superusers=e,a(LPServer.extend({},r,{params:{userInfo:s},success:function(e){n(e,r)}}))};return function(e){LPServer.jsonRequest({url:"getSuperUserInfo.php",success:t,userSupplied:e})}}(),u=function(){var r={ok:function(r,a){e(LPServer.ext.translate("Shared Folder %1 was renamed.",a.params.shareInfo.name),a)}};return function(e){e.params.shareInfo.name=e.params.sharedFolder.group.substring("Shared-".length),e.params.shareInfo.sharename=LPServer.ext.encryptCBC(e.params.sharedFolder.group,e.params.shareInfo.key),LPServer.xmlRequest({url:"share.php",data:{update:1,rename:1,id:e.params.shareInfo.id,name:e.params.shareInfo.name,sharename:e.params.shareInfo.sharename,xmlr:1},callbacks:r,userSupplied:e})}}(),i=function(){var r=function(r,a){a.params.shareInfo.deleted="1",e(LPServer.ext.translate("Shared Folder deleted."),a)};return function(e){LPServer.xmlRequest({url:"share.php",data:{id:e.params.shareInfo.id,delete:1,xmlr:1},callbacks:{deleted:r},userSupplied:e})}}(),d=function(){var e=function(e,r){r.success(LPServer.ext.translate("Member removed."))};return function(r){var a={id:r.params.shareid,xmlr:1};r.params.msfuser?(a.msfdelete=1,a.msfuser=r.params.uid):(a.update=1,a.delete=1,a.uid=r.params.uid),LPServer.xmlRequest({url:"share.php",data:a,callbacks:{ok:e},userSupplied:r})}}(),o=function(e){LPServer.jsonRequest({url:"getSharedFolderRestrictions.php",data:e.params,userSupplied:e})},p=function(e){LPServer.textRequest({url:"share.php",data:{id:e.params.shareid,edit:1,limit:1,aids:e.params.aids,numaids:e.params.aids.length>0?e.params.aids.split(",").length:0,additionaluids:e.params.additionaluids,hidebydefault:e.params.hidebydefault?1:0,uid:e.params.uid,xmlr:1},success:function(){e.success(LPServer.ext.translate("Access restrictions updated."))},userSupplied:e})},l=function(){var e=function(e,r){r.success(LPServer.ext.translate("Permissions saved."))};return function(r){LPServer.xmlRequest({url:"editSharedFolderUsers.php",data:{cmd:"edit",xml:1,shareid:r.params.shareInfo.id,request:JSON.stringify(r.params.updatedPermissions)},callbacks:{ok:e},userSupplied:r})}}(),c=function(e,r,a){var s={id:r.params.shareInfo.id,xmlr:1};s[e]=1,LPServer.xmlRequest({url:"share.php",data:s,callbacks:a,userSupplied:r})},m=function(){var r=function(r,a){a.params.shareInfo.download="1",e(LPServer.ext.translate("Shared Folder will now be downloaded."),a)};return function(e){c("startdownloading",e,{ok:r})}}(),f=function(){var r=function(r,a){a.params.shareInfo.download="0",e(LPServer.ext.translate("Shared Folder will no longer be downloaded."),a)};return function(e){c("stopdownloading",e,{ok:r})}}(),h=function(){var r={undeleted:function(r,a){a.params.shareInfo.deleted="0",e(LPServer.ext.translate("Shared Folder restored."),a)}};return function(e){LPServer.xmlRequest({url:"share.php",data:{id:e.params.shareInfo.id,undelete:1,xmlr:1},callbacks:r,userSupplied:e})}}(),v=function(){var e={purged:function(e,r){r.success(LPServer.ext.translate("Shared Folder purged."))}};return function(r){LPServer.xmlRequest({url:"share.php",data:{id:r.params.shareInfo.id,purge:1,xmlr:1},callbacks:e,userSupplied:r})}}(),S=function(){var e=function(e,r){r.success(e.folders)};return function(r){LPServer.jsonRequest({url:"getSharedFolderInfo.php",success:e,userSupplied:r})}}(),P=function(){var r={success:function(r,a){a.params.shareInfo.accepted="1",e(LPServer.ext.translate("Shared Folder accepted."),a)}};return function(e){LPServer.jsonRequest({url:"share.php",data:{folder:e.params.shareInfo.id,acceptfolder:1,jsonr:1},callbacks:r,userSupplied:e})}}(),g=function(){var e={success:function(e,r){r.success(LPServer.ext.translate("Shared Folder rejected."))}};return function(r){LPServer.jsonRequest({url:"share.php",data:{id:r.params.shareInfo.id,rejectfolder:1,jsonr:1},callbacks:e,userSupplied:r})}}(),L=function(){var e={success:function(e,r){r.success(LPServer.ext.translate("Shared Folder member reinvited."))}};return function(r){var a={reinvite:1,invitee:r.params.uid,folder:r.params.shareid,jsonr:1};"1"===r.params.ent&&(a.ent="on"),LPServer.jsonRequest({url:"share.php",data:a,callbacks:e,userSupplied:r})}}(),y=function(){var a={success:function(r,a){a.params.shareInfo.cid=LPServer.getAttr(r,"cid"),a.params.shareInfo.outside_enterprise=LPServer.getAttr(r,"outside_enterprise"),e(LPServer.ext.translate("Personal Shared Folder moved into Enterprise. You can now adminster the folder."),a)}},s=function(e,s){var n={id:s.params.shareInfo.id,moveintoenterprise:1,xmlr:1};r(n,e,s.params.shareInfo.key),LPServer.xmlRequest({url:"share.php",data:n,callbacks:a,userSupplied:s})};return function(e){LPServer.jsonRequest({url:"getSuperUserInfo.php",success:s,userSupplied:e})}}();return{SHARED_FOLDER_NAME_PREFIX:"Shared-",getFolders:S,getPublicKeys:a,create:t,rename:u,remove:i,accept:P,reject:g,addMembers:n,getMembers:s,removeMember:d,reinviteMember:L,updateMemberPermissions:l,getRestrictions:o,updateRestrictions:p,startDownloading:m,stopDownloading:f,restoreDeleted:h,purgeDeleted:v,convertToEnterprise:y}}();