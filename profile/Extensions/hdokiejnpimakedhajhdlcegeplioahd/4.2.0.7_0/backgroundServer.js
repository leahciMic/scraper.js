BackgroundServer=function(e){LPServer.initialize(e,{ajax:function(e){e.data&&(e.data.method=get_method()),LPPlatform.ajax(e)}});var s=function(e){return function(){e.apply(this,arguments),increment_local_accts_version(),rewritelocalfile()}},r=function(e,s,r){s instanceof Array?s.push(e):s[e[r]]=e},i=s(r),n=function(e,s,r){if(s instanceof Array){for(var i=0,n=s.length;i<n;++i)if(e[r]===s[i][r]){s[i]=e;break}}else s[e[r]]=e},t=s(n),a=function(e,s,r){if(e instanceof Array){for(var i=0,n=e.length;i<n;++i)if(r===e[i][s]){e.splice(i,1);break}}else delete e[s]},c=s(a),o=function(e,s,r){if(!(e instanceof Array))return e[s];for(var i=0,n=e.length;i<n;++i)if(r===e[i][s])return e[i]};return{emergencyAccess:{updateRecipient:function(e){var s=e.success;e.success=function(r){t(e.params.recipient,g_emer_sharees,"username"),s(e.params.recipient)},LPServer.emergencyAccess.updateRecipient(e)},addRecipient:function(e){var s=e.success;e.success=function(r){i(e.params.recipient,g_emer_sharees,"username"),s(e.params.recipient)},LPServer.emergencyAccess.addRecipient(e)},removeRecipient:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_emer_sharees,"username",e.params.id)}),LPServer.emergencyAccess.removeRecipient(e)},getRecipientInfo:function(e){LPServer.emergencyAccess.getRecipientInfo(e)},getSharerInfo:function(e){LPServer.emergencyAccess.getSharerInfo(e)},acceptOffer:function(e){var s=e.success;e.success=function(){var r=e.params.sharer;r.accepted="1",t(r,g_emer_sharers,"username"),s(r)},LPServer.emergencyAccess.acceptOffer(e)},declineOffer:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_emer_sharers,"username",e.params.email)}),LPServer.emergencyAccess.declineOffer(e)},requestAccess:function(e){e.callbacks=e.callbacks||{};var s=e.callbacks.successLinked;e.callbacks.successLinked=function(e,r){var i=r.params.sharer;i.confirmed="1",i.allowed_access="1",i.linked="1",i.override_date=new Date,refreshsites(),s&&s(i,r)};var r=e.callbacks.successGranted;e.callbacks.successGranted=function(e,s){var i=s.params.sharer;i.confirmed="1",i.override_date=new Date,i.override_date.setTime(i.override_date.getTime()+60*i.hours_to_override*60*1e3),r&&r(i,s)},LPServer.emergencyAccess.requestAccess(e)},denyAccess:function(e){e.success=LPServer.extendCallback(e.success,function(){var s=o(g_emer_sharees,"username",e.params.email);s.confirmed="0",s.allowed_access="0"}),LPServer.emergencyAccess.denyAccess(e)},unlinkAccount:function(e){e.success=LPServer.extendCallback(e.success,s(function(){if(e.params.folderID)delete g_sites[e.params.folderID];else for(var s in g_sites){var r=g_sites[s];if("http://group"===r.url&&r.group===e.params.email){delete g_sites[s];break}}})),LPServer.emergencyAccess.unlinkAccount(e)}},identities:{add:function(e){var s=e.success;e.success=function(r){var n=e.params.identity;n.iid=LPServer.getAttr(r,"iid",""),i(n,g_identities,"iid"),s(n)},LPServer.identities.add(e)},remove:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_identities,"iid",e.params.id)}),LPServer.identities.remove(e)},update:function(e){var s=e.success;e.success=function(){var r=e.params.identity;t(r,g_identities,"iid"),s(r)},LPServer.identities.update(e)}},vault:{history:{revertPasswordChange:function(){LPServer.vault.history.revertPasswordChange.apply(this,arguments)},getPasswordHistory:function(){LPServer.vault.history.getPasswordHistory.apply(this,arguments)},getUsernameHistory:function(){LPServer.vault.history.getUsernameHistory.apply(this,arguments)},getNoteHistory:function(){LPServer.vault.history.getNoteHistory.apply(this,arguments)}}},sharing:{individual:{shareItems:function(e){LPServer.sharing.individual.shareItems(e)},unshareItem:function(e){LPServer.sharing.individual.unshareItem(e)},acceptShare:function(e){e.success=LPServer.extendCallback(e.success,function(){refreshsites()}),LPServer.sharing.individual.acceptShare(e)},rejectShare:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_pendings,"id",e.params.id)}),LPServer.sharing.individual.rejectShare(e)},inviteFriends:function(e){LPServer.sharing.individual.inviteFriends(e)},getSentShareData:function(e){LPServer.sharing.individual.getSentShareData(e)},getReceivedShareData:function(e){LPServer.sharing.individual.getReceivedShareData(e)}},folder:{getFolders:function(e){LPServer.sharing.folder.getFolders(e)},getPublicKeys:function(e){LPServer.sharing.folder.getPublicKeys(e)},create:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){s.shareInfo.sharekeyaes=lpmenc(AES.bin2hex(s.shareInfo.key),!0,g_local_key),s.sharedFolder.sharefolderid=s.sharedFolder.aid,r(s.shareInfo,g_shares,"id"),r(s.sharedFolder,g_sites,"aid")})),e.params.username=g_username,LPServer.sharing.folder.create(e)},rename:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){n(s.shareInfo,g_shares,"id"),n(s.sharedFolder,g_sites,"aid")})),LPServer.sharing.folder.rename(e)},remove:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){n(s.shareInfo,g_shares,"id");for(var r in g_sites){g_sites[r].sharefolderid===s.shareInfo.id&&delete g_sites[r]}})),LPServer.sharing.folder.remove(e)},accept:function(e){e.success=LPServer.extendCallback(e.success,function(){a(g_pending_shares,"id",e.params.shareInfo.id),refreshsites()}),LPServer.sharing.folder.accept(e)},reject:function(e){e.success=LPServer.extendCallback(e.success,s(function(){a(g_pending_shares,"id",e.params.shareInfo.id)})),LPServer.sharing.folder.reject(e)},addMembers:function(e){LPServer.sharing.folder.addMembers(e)},getMembers:function(e){LPServer.sharing.folder.getMembers(e)},removeMember:function(e){LPServer.sharing.folder.removeMember(e)},reinviteMember:function(e){LPServer.sharing.folder.reinviteMember(e)},updateMemberPermissions:function(e){LPServer.sharing.folder.updateMemberPermissions(e)},getRestrictions:function(e){LPServer.sharing.folder.getRestrictions(e)},updateRestrictions:function(e){LPServer.sharing.folder.updateRestrictions(e)},startDownloading:function(e){e.success=LPServer.extendCallback(e.success,function(e,s){refreshsites()}),LPServer.sharing.folder.startDownloading(e)},stopDownloading:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){n(s.shareInfo,g_shares,"id");for(var r in g_sites){g_sites[r].sharefolderid===s.shareInfo.id&&delete g_sites[r]}})),LPServer.sharing.folder.stopDownloading(e)},restoreDeleted:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){n(s.shareInfo,g_shares,"id"),refreshsites()})),LPServer.sharing.folder.restoreDeleted(e)},purgeDeleted:function(e){e.success=LPServer.extendCallback(e.success,s(function(){a(g_shares,"id",e.params.shareid),a(g_sites,"aid",e.params.shareid)})),LPServer.sharing.folder.purgeDeleted(e)},convertToEnterprise:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){n(s.shareInfo,g_shares,"id"),n(s.sharedFolder,g_sites,"aid")})),LPServer.sharing.folder.convertToEnterprise(e)}}},sitesAndNotes:{saveCustomNoteTemplate:function(e){e.success=LPServer.extendCallback(e.success,s(function(e,s){r(s,g_note_templates,"id")})),LPServer.sitesAndNotes.saveCustomNoteTemplate(e)},deleteCustomNoteTemplate:function(e){e.success=LPServer.extendCallback(e.success,s(function(s,r){a(g_note_templates,"id",e.params.id)})),LPServer.sitesAndNotes.deleteCustomNoteTemplate(e)}},transact:{sendReminder:function(e){LPServer.transact.sendReminder(e)}},families:{optIn:function(e){LPServer.lmiapi.jsonRequest({url:"lmiapi/families/opt-in",method:"POST",success:function(){refreshsites()},userSupplied:e})},getMembers:function(e){LPServer.jsonRequest({url:"typeahead_remote.php",method:"GET",success:e.success,error:e.error})},existingUserTrial:function(e){LPServer.lmiapi.jsonRequest({url:"lmiapi/families/trial/existing-user",method:"POST",data:e.params,userSupplied:{error:e.error},success:function(){refreshsites()}})},getInvitations:function(e){LPServer.lmiapi.jsonRequest({url:"lmiapi/families/invitations",type:"GET",success:e.success,userSupplied:e})}},invitation:{acceptInvitation:function(e){LPServer.lmiapi.jsonRequest({url:"lmiapi/invitations/"+e.params.invitationId+"/accept",type:"POST",success:function(){refreshsites()},userSupplied:e})},dismissInvitation:function(e){LPServer.lmiapi.jsonRequest({url:"lmiapi/invitations/"+e.params.invitationId+"/dismiss",type:"POST",success:e.success,userSupplied:e})}}}}(this);